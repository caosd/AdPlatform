<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.stomato.dao.UserDao">

	<resultMap type="com.stomato.domain.User" id="user"> 
		<result property="id" column="id" />
		<result property="userName" column="account_name" />
		<result property="accountType" column="account_type"/>
		<result property="email" column="email"/>
		<result property="companyName" column="company_name"/>
		<result property="country" column="country"/>
		<result property="firstName" column="first_name"/>
		<result property="lastName" column="last_name"/>
		<result property="address" column="address" />
		<result property="regDate" column="reg_date" />
        <result property="loginTokenTime" column="login_token_time" />
	</resultMap>
	
	<insert id="addUser" parameterType="com.stomato.domain.User">
		insert into t_user(account_name, account_pwd, account_type, email, company_name, country, first_name, last_name, address, reg_date)
					values(#{userName}, upper(md5(#{password})), #{accountType}, #{email}, #{companyName}, #{country}, #{firstName}, #{lastName}, #{address}, now())
	</insert>
	
	<select id="getUser" parameterType="com.stomato.domain.User" resultMap="user" >
		select * from t_user where account_name=#{userName} and (account_pwd=upper(md5(#{password})) or login_token=#{loginToken})
	</select>
	
	<update id="updateLoginToken" parameterType="com.stomato.domain.User">
		update t_user set login_token=#{loginToken}, login_token_time=now() where id=#{id}
	</update>
	
	<update id="updateUser" parameterType="com.stomato.domain.User">
		update t_user set account_type=#{accountType},company_name=#{companyName},country=#{country},first_name=#{firstName},last_name=#{lastName},address=#{address}
		where id=#{id}
	</update>
	
	<update id="updatePassword" parameterType="com.stomato.domain.User">
        update t_user set account_pwd=upper(md5(#{password})) where id=#{id}
    </update>
    
	<update id="updateEmail" parameterType="com.stomato.domain.User">
        update t_user set email=#{email} where id=#{id}
    </update>
	
	<select id="verify" parameterType="com.stomato.domain.User" resultMap="user">
        select * from t_user where account_name=#{userName} or email=#{email} limit 0,1
    </select>
    
	<select id="getUserByEmail" parameterType="String" resultMap="user">
        select * from t_user where email=#{email}
    </select>
    
</mapper>